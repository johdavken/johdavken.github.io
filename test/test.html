<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ResinIQ</title>

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <style>
    :root{
      /* Core theme tokens (defaults = Dark) */
      --bg:#0b0f14;
      --panel: rgba(18,26,35,.88);
      --panel2: rgba(15,22,32,.76);
      --muted:#9bb0c6;
      --text:#eaf2ff;
      --subtitle: #5dff9f;
      --title: #4aa3ff;

      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);

      --warn:#ffb020;
      --bad:#ff5c5c;
      --ok:#5dff9f;

      --shadow2: 0 8px 20px rgba(0,0,0,.25);
      --radius2:18px;

      --field-bg: rgba(0,0,0,.20);
      --panelOpen: rgba(18,26,35,.92); /* open details background */
      --chev: rgba(255,255,255,.45);

      /* Common surface tokens (reduce per-component duplication) */
      --row-bg: rgba(255,255,255,.04);
      --row-border: rgba(255,255,255,.07);
      --row-bg-2: rgba(255,255,255,.03);
      --row-border-2: rgba(255,255,255,.07);

      --readonly-bg: rgba(255,255,255,.06);
      --readonly-border: rgba(255,255,255,.10);

      --focus-border: rgba(74,163,255,.80);
      --focus-ring: rgba(74,163,255,.16);

      /* Density tokens (default = Comfort) */
      --font-base: 16px;
      --font-small: 12px;
      --font-tiny: 11px;
      --pad-input-y: 8px;
      --pad-input-x: 12px;
      --pad-card: 12px;
      --gap: 10px;
      --row-pad: 6px;
      --radius-input: 14px;
      --radius-row: 16px;
      --toggle-w: 52px;
      --toggle-h: 30px;
      --toggle-knob: 24px;
      --badge-font: 12px;

      /* Formula colors (defaults) */
      --f-var1: #5dff9f;
      --f-var2: #ffb020;
      --f-var3: #4aa3ff;
      --f-const: #9bb0c6;
    }

    /* Light theme */
    body[data-theme="light"]{
      --bg: #f4f7fb;
      --panel: rgba(255,255,255,.95);
      --panel2: rgba(255,255,255,.85);
      --text: #0f172a;
      --subtitle: #475569;
      --title: #1e40af;
      --muted: #5b6b82;
      --border: rgba(15,23,42,.12);
      --border2: rgba(15,23,42,.18);
      --field-bg: rgba(15,23,42,.06);
      --panelOpen: rgba(255,255,255,.95);
      --chev: rgba(15,23,42,.45);

      --warn: #d97706;
      --bad: #dc2626;
      --ok: #16a34a;

      --shadow2: 0 6px 18px rgba(0,0,0,.12);

      --row-bg: rgba(15,23,42,.04);
      --row-border: rgba(15,23,42,.10);
      --row-bg-2: rgba(15,23,42,.03);
      --row-border-2: rgba(15,23,42,.10);

      --readonly-bg: rgba(15,23,42,.06);
      --readonly-border: rgba(15,23,42,.12);

      --focus-border: rgba(74,163,255,.80);
      --focus-ring: rgba(74,163,255,.14);
    }

    /* Gruvbox Dark */
    body[data-theme="gruvbox-dark"]{
      --bg: #282828;               /* bg0 */
      --panel: rgba(50,48,47,.95); /* bg0_s */
      --panel2: rgba(60,56,54,.88);/* bg1 */
      --text: #ebdbb2;             /* fg1 */
      --title: #fb4943;            /* fg1 (strong) */
      --subtitle: #83a598;         /* fg3 */
      --muted: #a89984;            /* fg4 */
      --border: rgba(80,73,69,.65);/* bg2 */
      --border2: rgba(102,92,84,.55);/* bg3 */
      --field-bg: rgba(60,56,54,.75); /* bg1 */
      --panelOpen: rgba(50,48,47,.98);
      --chev: rgba(235,219,178,.55);

      --warn: #d79921;             /* yellow */
      --bad: #cc241d;              /* red */
      --ok: #98971a;               /* green */

      --shadow2: 0 8px 20px rgba(0,0,0,.30);

      --focus-border: rgba(215,153,33,.80);
      --focus-ring: rgba(215,153,33,.18);

      --row-bg: rgba(235,219,178,.04);
      --row-border: rgba(102,92,84,.26);
      --row-bg-2: rgba(235,219,178,.03);
      --row-border-2: rgba(102,92,84,.26);

      --readonly-bg: rgba(0,0,0,.10);
      --readonly-border: rgba(124,111,100,.35);

      --f-var1: #98971a; /* green */
      --f-var2: #d79921; /* yellow */
      --f-var3: #458588; /* blue */
      --f-const: #928374; /* gray */
    }

    /* Gruvbox Light */
    body[data-theme="gruvbox-light"]{
      --bg: #fbf1c7;               /* bg0 */
      --panel: rgba(235,219,178,.92); /* bg1 */
      --panel2: rgba(213,196,161,.86);/* bg2 */
      --text: #3c3836;
      --subtitle: #076678;
      --title: #9d0006;             /* fg0 (dark) */
      --muted: #665c54;            /* fg2-ish */
      --border: rgba(102,92,84,.35);
      --border2: rgba(124,111,100,.35);
      --field-bg: rgba(235,219,178,.70);
      --panelOpen: rgba(235,219,178,.96);
      --chev: rgba(60,56,54,.55);

      --warn: #d79921;             /* yellow */
      --bad: #cc241d;              /* red */
      --ok: #98971a;               /* green */

      --shadow2: 0 6px 18px rgba(0,0,0,.14);

      --focus-border: rgba(215,153,33,.80);
      --focus-ring: rgba(215,153,33,.18);

      --row-bg: rgba(60,56,54,.04);
      --row-border: rgba(102,92,84,.22);
      --row-bg-2: rgba(60,56,54,.03);
      --row-border-2: rgba(102,92,84,.22);

      --readonly-bg: rgba(60,56,54,.06);
      --readonly-border: rgba(102,92,84,.25);

      --f-var1: #98971a; /* green */
      --f-var2: #d79921; /* yellow */
      --f-var3: #458588; /* blue */
      --f-const: #928374; /* gray */
    }


    /* Nord */
    body[data-theme="nord"]{
      --bg: #2e3440;
      --panel: rgba(59,66,82,.95);
      --panel2: rgba(67,76,94,.88);
      --text: #eceff4;
      --subtitle: #a3be8c;
      --title: #88c0d0;
      --muted: #d8dee9;
      --border: rgba(76,86,106,.55);
      --border2: rgba(94,129,172,.35);
      --field-bg: rgba(67,76,94,.62);
      --panelOpen: rgba(59,66,82,.98);
      --chev: rgba(236,239,244,.55);

      --warn: #ebcb8b;
      --bad: #bf616a;
      --ok: #a3be8c;

      --shadow2: 0 8px 20px rgba(0,0,0,.30);
    }

    /* Tokyo Night */
    body[data-theme="tokyo-night"]{
      --bg: #1a1b26;
      --panel: rgba(36,40,59,.95);
      --panel2: rgba(41,46,66,.88);
      --text: #c0caf5;
      --subtitle: #9ece6a;
      --title: #7aa2f7;
      --muted: #a9b1d6;
      --border: rgba(65,72,104,.55);
      --border2: rgba(122,162,247,.30);
      --field-bg: rgba(41,46,66,.62);
      --panelOpen: rgba(36,40,59,.98);
      --chev: rgba(192,202,245,.55);

      --warn: #e0af68;
      --bad: #f7768e;
      --ok: #9ece6a;

      --shadow2: 0 8px 22px rgba(0,0,0,.30);
    }

    /* Dracula */
    body[data-theme="dracula"]{
      --bg: #282a36;
      --panel: rgba(68,71,90,.95);
      --panel2: rgba(52,55,70,.88);
      --text: #f8f8f2;
      --subtitle: #50fa7b;
      --title: #bd93f9;
      --muted: #c7c3e0;
      --border: rgba(98,114,164,.45);
      --border2: rgba(189,147,249,.28);
      --field-bg: rgba(68,71,90,.58);
      --panelOpen: rgba(68,71,90,.98);
      --chev: rgba(248,248,242,.55);

      --warn: #f1fa8c;
      --bad: #ff5555;
      --ok: #50fa7b;

      --shadow2: 0 8px 22px rgba(0,0,0,.32);
    }

    /* Solarized Dark */
    body[data-theme="solarized-dark"]{
      --bg: #002b36;
      --panel: rgba(7,54,66,.95);
      --panel2: rgba(0,43,54,.88);
      --text: #eee8d5;
      --subtitle: #859900;
      --title: #268bd2;
      --muted: #93a1a1;
      --border: rgba(88,110,117,.45);
      --border2: rgba(38,139,210,.28);
      --field-bg: rgba(7,54,66,.58);
      --panelOpen: rgba(7,54,66,.98);
      --chev: rgba(238,232,213,.55);

      --warn: #b58900;
      --bad: #dc322f;
      --ok: #859900;

      --shadow2: 0 8px 22px rgba(0,0,0,.30);
    }

    /* Solarized Light */
    body[data-theme="solarized-light"]{
      --bg: #fdf6e3;
      --panel: rgba(255,255,255,.96);
      --panel2: rgba(238,232,213,.90);
      --text: #073642;
      --subtitle: #859900;
      --title: #268bd2;
      --muted: #586e75;
      --border: rgba(147,161,161,.45);
      --border2: rgba(38,139,210,.28);
      --field-bg: rgba(238,232,213,.70);
      --panelOpen: rgba(255,255,255,.96);
      --chev: rgba(7,54,66,.55);

      --warn: #b58900;
      --bad: #dc322f;
      --ok: #859900;

      --shadow2: 0 6px 18px rgba(0,0,0,.14);
    }

    /* Catppuccin Mocha */
    body[data-theme="catppuccin-mocha"]{
      --bg: #1e1e2e;
      --panel: rgba(49,50,68,.95);
      --panel2: rgba(69,71,90,.88);
      --text: #cdd6f4;
      --subtitle: #a6e3a1;
      --title: #89b4fa;
      --muted: #a6adc8;
      --border: rgba(88,91,112,.55);
      --border2: rgba(137,180,250,.30);
      --field-bg: rgba(49,50,68,.62);
      --panelOpen: rgba(49,50,68,.98);
      --chev: rgba(205,214,244,.55);

      --warn: #f9e2af;
      --bad: #f38ba8;
      --ok: #a6e3a1;

      --shadow2: 0 8px 22px rgba(0,0,0,.30);
    }

    /* Catppuccin Latte */
    body[data-theme="catppuccin-latte"]{
      --bg: #eff1f5;
      --panel: rgba(255,255,255,.96);
      --panel2: rgba(230,233,239,.90);
      --text: #4c4f69;
      --subtitle: #40a02b;
      --title: #1e66f5;
      --muted: #6c6f85;
      --border: rgba(156,160,176,.40);
      --border2: rgba(30,102,245,.22);
      --field-bg: rgba(220,224,232,.70);
      --panelOpen: rgba(255,255,255,.96);
      --chev: rgba(76,79,105,.55);

      --warn: #df8e1d;
      --bad: #d20f39;
      --ok: #40a02b;

      --shadow2: 0 6px 18px rgba(0,0,0,.12);
    }

    /* Amber */
    body[data-theme="amber"]{
      --bg: #0b0a06;
      --panel: rgba(20,16,10,.92);
      --panel2: rgba(18,14,8,.78);
      --text: #fffbeb;
      --subtitle: #84cc16;
      --title: #fbbf24;
      --muted: rgba(252,211,77,.85);
      --border: rgba(251,191,36,.22);
      --border2: rgba(251,191,36,.28);
      --field-bg: rgba(251,191,36,.10);
      --panelOpen: rgba(20,16,10,.95);
      --chev: rgba(255,251,235,.55);

      --warn: #f59e0b;
      --bad: #ef4444;
      --ok: #84cc16;

      --shadow2: 0 8px 22px rgba(0,0,0,.32);
    }

    /* High Contrast */
    body[data-theme="high-contrast"]{
      --bg: #000000;
      --panel: rgba(0,0,0,.95);
      --panel2: rgba(0,0,0,.85);
      --text: #ffffff;
      --subtitle: #ffffff;
      --title: #ffffff;
      --muted: #d1d5db;
      --border: rgba(255,255,255,.35);
      --border2: rgba(255,255,255,.45);
      --field-bg: rgba(255,255,255,.10);
      --panelOpen: rgba(0,0,0,.95);
      --chev: rgba(255,255,255,.75);

      --warn: #fbbf24;
      --bad: #ef4444;
      --ok: #22c55e;

      --shadow2: 0 10px 28px rgba(0,0,0,.55);
    }

    /* Monochrome */
    body[data-theme="mono"]{
      --bg: #f6f6f6;
      --panel: rgba(255,255,255,.96);
      --panel2: rgba(245,245,245,.92);
      --text: #111827;
      --subtitle: #374151;
      --title: #111827;
      --muted: #374151;
      --border: rgba(17,24,39,.18);
      --border2: rgba(17,24,39,.22);
      --field-bg: rgba(17,24,39,.06);
      --panelOpen: rgba(255,255,255,.96);
      --chev: rgba(17,24,39,.55);

      --warn: #111827;
      --bad: #111827;
      --ok: #111827;

      --shadow2: 0 6px 18px rgba(0,0,0,.10);
    }
/* Compact */
    body[data-density="compact"]{
      --font-base: 15px;
      --font-small: 11px;
      --font-tiny: 10px;
      --pad-input-y: 7px;
      --pad-input-x: 10px;
      --pad-card: 10px;
      --gap: 8px;
      --row-pad: 4px;
      --radius-input: 13px;
      --radius-row: 15px;
      --toggle-w: 48px;
      --toggle-h: 28px;
      --toggle-knob: 22px;
      --badge-font: 11px;
    }

    /* Dense */
    body[data-density="dense"]{
      --font-base: 11px;
      --font-small: 9px;
      --font-tiny: 8px;
      --pad-input-y: 6px;
      --pad-input-x: 7px;
      --pad-card: 5px;
      --gap: 4px;
      --row-pad: 4px;
      --radius-input: 10px;
      --radius-row: 10px;
      --toggle-w: 40px;
      --toggle-h: 20px;
      --toggle-knob: 17px;
      --badge-font: 11px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(74,163,255,.16), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(93,255,159,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-size: var(--font-base);
    }

    /* Theme-specific background glow (keeps each theme feeling “native”) */
    body[data-theme="gruvbox-dark"],
    body[data-theme="gruvbox-light"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(214,93,14,.10), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(152,151,26,.08), transparent 55%),
        var(--bg);
    }
    body[data-theme="nord"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(136,192,208,.12), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(163,190,140,.08), transparent 55%),
        var(--bg);
    }
    body[data-theme="tokyo-night"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(122,162,247,.12), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(158,206,106,.08), transparent 55%),
        var(--bg);
    }
    body[data-theme="dracula"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(189,147,249,.12), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(80,250,123,.08), transparent 55%),
        var(--bg);
    }
    body[data-theme="catppuccin-mocha"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(137,180,250,.12), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(166,227,161,.08), transparent 55%),
        var(--bg);
    }
    body[data-theme="solarized-dark"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(38,139,210,.10), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(133,153,0,.07), transparent 55%),
        var(--bg);
    }
    body[data-theme="solarized-light"],
    body[data-theme="catppuccin-latte"],
    body[data-theme="mono"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(38,139,210,.08), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(133,153,0,.06), transparent 55%),
        var(--bg);
    }
    body[data-theme="amber"]{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(251,191,36,.10), transparent 60%),
        radial-gradient(800px 500px at 90% 0%, rgba(132,204,22,.07), transparent 55%),
        var(--bg);
    }
    body[data-theme="high-contrast"]{
      background: var(--bg);
    }
main{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 24px;
      display: grid;
      gap: 16px;
    }

    /* Small utility classes (replaces repeated inline styles) */
    .mt10{ margin-top: 10px; }
    .mt14{ margin-top: 14px; }
    .gap10{ display:grid; gap:10px; }
    .hide{ display:none !important; }

    .appHeaderImage{
      display:flex;
      justify-content:center;
      margin: 8px 0 14px 0;
      opacity: 0.9;
    }
    .appHeaderImage img{
      width:100%;
      max-width:360px;
      height:auto;
      opacity:0.95;
    }
    @media (min-width:600px){ .appHeaderImage img{ max-width:460px; } }
    @media (min-width:900px){ .appHeaderImage img{ max-width:560px; } }

    .card{
      position: relative;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: var(--pad-card);
      box-shadow: var(--shadow2);
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: linear-gradient(135deg, rgba(74,163,255,.14), rgba(93,255,159,.10), transparent 60%);
      opacity: .55;
      pointer-events:none;
      filter: blur(14px);
    }
    body[data-theme="gruvbox-dark"] .card::before,
    body[data-theme="gruvbox-light"] .card::before{
      background: linear-gradient(135deg, rgba(214,93,14,.12), rgba(152,151,26,.10), transparent 60%);
      opacity: .45;
    }

    body[data-theme="nord"] .card::before{
      background: linear-gradient(135deg, rgba(136,192,208,.14), rgba(163,190,140,.10), transparent 60%);
      opacity: .45;
    }
    body[data-theme="tokyo-night"] .card::before{
      background: linear-gradient(135deg, rgba(122,162,247,.14), rgba(158,206,106,.10), transparent 60%);
      opacity: .45;
    }
    body[data-theme="dracula"] .card::before{
      background: linear-gradient(135deg, rgba(189,147,249,.14), rgba(80,250,123,.10), transparent 60%);
      opacity: .45;
    }
    body[data-theme="catppuccin-mocha"] .card::before{
      background: linear-gradient(135deg, rgba(137,180,250,.14), rgba(166,227,161,.10), transparent 60%);
      opacity: .45;
    }
    body[data-theme="solarized-dark"] .card::before,
    body[data-theme="solarized-light"] .card::before,
    body[data-theme="catppuccin-latte"] .card::before,
    body[data-theme="mono"] .card::before{
      background: linear-gradient(135deg, rgba(38,139,210,.10), rgba(133,153,0,.07), transparent 60%);
      opacity: .35;
    }
    body[data-theme="amber"] .card::before{
      background: linear-gradient(135deg, rgba(251,191,36,.12), rgba(132,204,22,.08), transparent 60%);
      opacity: .40;
    }
    body[data-theme="high-contrast"] .card::before{ display:none; }
.card > *{ position: relative; }

    /* ===== Card header typography ===== */

.layerTitle{
  font-weight: 900;
  font-size: 14px;
  white-space: nowrap;
  color: var(--title, var(--text));
}

.layerMeta{
  color: var(--subtitle, var(--muted));
  font-size: var(--font-small);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}


    .card h2{ margin:0 0 10px 0; font-size:15px; letter-spacing:.2px; }
    .muted{ color: var(--muted); font-size: var(--font-small); }
    .tiny{ font-size: var(--font-tiny); color: var(--muted); margin-top: 6px; line-height: 1.35; }
    .mono{
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    label{ display:block; font-size: var(--font-small); color: var(--muted); margin-bottom: 6px; }
    input, select, textarea{
      width: 100%;
      padding: var(--pad-input-y) var(--pad-input-x);
      border-radius: var(--radius-input);
      border: 1px solid var(--border2);
      background: var(--field-bg);
      color: var(--text);
      outline: none;
      font-size: var(--font-base);
      transition: box-shadow .12s ease, border-color .12s ease, transform .06s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--focus-border);
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    textarea{ min-height: 120px; resize: vertical; }

    /* Read-only inputs should NOT look editable */
    input[readonly]{
      opacity: 0.75;
      cursor: not-allowed;
      background: var(--readonly-bg);
      border-color: var(--readonly-border);
      box-shadow: none;
    }
    input[readonly]:focus{
      outline: none;
      border-color: var(--readonly-border);
      box-shadow: none;
    }

    .grid3{ display:grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 720px){ .grid3{ grid-template-columns: 1.2fr 1fr 1fr; } }

    .grid2{ display:grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 720px){ .grid2{ grid-template-columns: 1fr 1fr; } }

    .gridAuto{ display:grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 720px){ .gridAuto{ grid-template-columns: repeat(3, 1fr); } }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: var(--font-small);
      white-space: nowrap;
    }
    /* TEMP: hide right-side card labels */
    details.block > summary .pill{ display: none; }

    .pill.badge-warn{
      border-color: rgba(255,176,32,.55);
      background: rgba(255,176,32,.12);
      color: rgba(255,255,255,.92);
      font-weight: 650;
    }
    body[data-theme="light"] .pill.badge-warn,
    body[data-theme="gruvbox-light"] .pill.badge-warn,
    body[data-theme="gruvbox-dark"] .pill.badge-warn{
      color: var(--text);
      border-color: rgba(215,153,33,.55);
      background: rgba(215,153,33,.18);
    }

    .status{
      margin-top:10px;
      border-left: 4px solid var(--warn);
      background: rgba(255,176,32,.08);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
    }
    .status.bad{ border-left-color: var(--bad); background: rgba(255,92,92,.08); }
    .status.ok{ border-left-color: var(--ok); background: rgba(93,255,159,.07); }

    body[data-theme="gruvbox-dark"] .status{ background: rgba(215,153,33,.10); }
    body[data-theme="gruvbox-light"] .status{ background: rgba(215,153,33,.14); }
    body[data-theme="gruvbox-dark"] .status.bad{ background: rgba(204,36,29,.10); }
    body[data-theme="gruvbox-light"] .status.bad{ background: rgba(204,36,29,.12); }
    body[data-theme="gruvbox-dark"] .status.ok{ background: rgba(152,151,26,.10); }
    body[data-theme="gruvbox-light"] .status.ok{ background: rgba(152,151,26,.14); }

    .status ul{ margin: 6px 0 0 0; padding-left: 18px; }

    /* Blocks */
    details.block{
      display:block;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: hidden;
      background: var(--panel2);
      box-shadow: 0 8px 18px rgba(0,0,0,.20);
    }
    details.block[open]{ background: var(--panelOpen); }

    /* Make nested blocks inside a card always span full width */
    .blockBody > details.block{
      width: 100%;
      grid-column: 1 / -1;
    }

    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    summary:hover .chev{ border-color: var(--focus-border); }

    .sumLeft{ display:flex; align-items:center; gap:10px; min-width: 0; }
    .chev{
      width: 15px; height: 15px;
      border-right: 2px solid var(--chev);
      border-bottom: 2px solid var(--chev);
      transform: rotate(-45deg);
      transition: transform .15s ease;
      flex: 0 0 auto;
      margin-left: 2px;
    }
    details[open] > summary .chev{ transform: rotate(45deg); }

    .blockBody{ padding: 0 12px 12px 12px; display:grid; gap: var(--gap); }
    .layerTitle{ font-weight: 900; font-size: 14px; white-space: nowrap; }
    .layerMeta{
      color: var(--subtitle, var(--muted));
      font-size: var(--font-small);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .copyBtn{
      width:auto;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: var(--font-small);
      cursor: pointer;
      box-shadow: none;
      flex: 0 0 auto;
    }
    body[data-theme="light"] .copyBtn,
    body[data-theme="gruvbox-light"] .copyBtn,
    body[data-theme="gruvbox-dark"] .copyBtn{
      color: var(--text);
      border-color: var(--readonly-border);
      background: var(--readonly-bg);
    }

    .hr{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    body[data-theme="light"] .hr{ background: rgba(15,23,42,.10); }
    body[data-theme="gruvbox-light"] .hr{ background: rgba(102,92,84,.25); }
    body[data-theme="gruvbox-dark"] .hr{ background: rgba(102,92,84,.30); }

    /* Hopper rows */
    .hopperList{ display: grid; gap: 10px; }
    .hopperRow{
      display:grid;
      gap: calc(var(--gap) + 2px);
      padding: max(4px, var(--row-pad));
      border-radius: var(--radius-row);
      background: var(--row-bg);
      border: 1px solid var(--row-border);
      align-items: center;
      grid-template-columns: auto minmax(140px, 1fr) 88px 120px;
    }
    .hopperRow input{
      padding: max(4px, calc(var(--pad-input-y) - 2px))
               max(6px, calc(var(--pad-input-x) - 4px));
      font-size: var(--font-small);
    }
    @media (max-width: 520px){
      .hopperRow{
        grid-template-columns: auto minmax(120px, 1fr) 58px 55px;
        gap: 6px;
      }
      .trackLabel{ display:none; }
    }

    .hopperBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--readonly-border);
      background: var(--readonly-bg);
      font-weight: 950;
      font-size: var(--badge-font);
      width: fit-content;
    }

    .resinNameInput{
      padding: var(--pad-input-y) var(--pad-input-x);
      border-radius: var(--radius-input);
      font-size: var(--font-base);
    }
    .splitInput{
      padding: var(--pad-input-y) var(--pad-input-x);
      border-radius: var(--radius-input);
      font-size: var(--font-base);
      text-align: right;
    }

    .trackWrap{
      display:flex;
      align-items:center;
      justify-content: flex-end;
      gap: 10px;
      user-select: none;
    }
    .trackLabel{ font-size: var(--font-small); color: var(--muted); white-space: nowrap; }

    .toggle{
      position: relative;
      width: var(--toggle-w);
      height: var(--toggle-h);
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.16);
      cursor: pointer;
      flex: 0 0 auto;
    }
    .toggle::after{
      content:"";
      position:absolute;
      top: 3px; left: 3px;
      width: var(--toggle-knob);
      height: var(--toggle-knob);
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      transition: transform .15s ease;
    }
    .toggle.on{
      background: rgba(74,163,255,.22);
      border-color: rgba(74,163,255,.45);
    }
    body[data-theme="gruvbox-dark"] .toggle.on,
    body[data-theme="gruvbox-light"] .toggle.on{
      background: rgba(215,153,33,.22);
      border-color: rgba(215,153,33,.45);
    }
    .toggle.on::after{
      transform: translateX(calc(var(--toggle-w) - var(--toggle-knob) - 6px));
    }

    /* Weights */
    .weightsGrid{ display:grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 720px){ .weightsGrid{ grid-template-columns: 1fr 1fr; } }
    .weightsLayer{
      border: 1px solid var(--row-border);
      border-radius: 18px;
      padding: 10px;
      background: var(--readonly-bg);
      display:grid;
      gap: var(--gap);
    }
    .weightsTitle{ display:flex; align-items:center; justify-content: space-between; gap: 10px; }
    .weightsTitle strong{ font-size: 13px; }
    .weightsRow{
      display:grid;
      gap: var(--gap);
      grid-template-columns: 70px 1fr;
      align-items:center;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid var(--row-border-2);
      background: var(--row-bg-2);
    }
    .weightsRow input{ text-align:right; }

    /* Results */
    .resultGrid{ display:grid; gap: var(--gap); }
    .resultRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: var(--gap);
      padding: var(--row-pad);
      border-radius: var(--radius-row);
      background: var(--row-bg-2);
      border: 1px solid var(--row-border-2);
      transition: opacity .12s ease, filter .12s ease, transform .08s ease;
    }
    .resultRow:hover{ transform: translateY(-1px); }
    .resultRow .meta{
      color: var(--muted);
      font-size: var(--font-small);
      margin-top: 4px;
      line-height: 1.35;
    }
    .resultRow.done{ opacity: 0.42; filter: grayscale(1); }
    .checkWrap{
      display:flex;
      align-items:center;
      gap: 8px;
      justify-content:flex-end;
      margin-top: 8px;
      color: var(--muted);
      font-size: var(--font-small);
      user-select: none;
    }
    .checkWrap input{ width: 18px; height: 18px; padding:0; margin:0; border-radius: 6px; }

    /* Resin calc */
    .calcTable{ margin-top: 10px; display:grid; gap: var(--gap); }
    .calcRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: var(--row-pad);
      border-radius: var(--radius-row);
      background: var(--row-bg-2);
      border: 1px solid var(--row-border-2);
    }
    .calcLeft{ display:flex; flex-direction: column; gap: 2px; min-width: 0; }
    .calcName{ font-weight: 950; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .calcMeta{ font-size: var(--font-small); color: var(--muted); }

    /* Inline layer % in the splits summary */
    .layerPctInline{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap: wrap;
    }
    .layerPctInline input{
      width: 92px;
      text-align: right;
      padding: max(4px, calc(var(--pad-input-y) - 2px)) max(6px, calc(var(--pad-input-x) - 4px));
      font-size: var(--font-small);
    }

    button{
      width: 100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(74,163,255,.22), rgba(74,163,255,.10));
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .08s ease, filter .12s ease;
      font-size: var(--font-base);
    }
    button:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    button:active{ transform: translateY(0px); }
    button.secondary{ background: rgba(255,255,255,.06); box-shadow:none; }
    button.danger{ background: rgba(255,92,92,.12); box-shadow:none; }

    body[data-theme="gruvbox-dark"] button,
    body[data-theme="gruvbox-light"] button{
      border-color: var(--readonly-border);
      background: linear-gradient(135deg, rgba(215,153,33,.22), rgba(215,153,33,.10));
    }
    body[data-theme="gruvbox-dark"] button.secondary,
    body[data-theme="gruvbox-light"] button.secondary{
      background: var(--readonly-bg);
    }
    body[data-theme="gruvbox-dark"] button.danger,
    body[data-theme="gruvbox-light"] button.danger{
      background: rgba(204,36,29,.14);
    }
    body[data-theme="light"] button.secondary{ background: rgba(15,23,42,.06); }
    body[data-theme="light"] button.danger{ background: rgba(220,38,38,.12); }

/* ===== Bottom status bar (Next Pump Off) ===== */
:root{
  --footer-msg-color: var(--text);
  --footer-sub-color: var(--muted);
  --footer-msg-size: 13px;
  --footer-sub-size: 11px;
  --footer-msg-weight: 950;
  --footer-sub-weight: 650;
}

.footerBar{
  position: fixed;
  left: 0; right: 0; bottom: 0;
  z-index: 41;
  padding: 8px 12px;
  background: rgba(11,15,20,.92);
  border-top: 1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
  text-align: center;
}

.footerMsg{
  color: var(--title, var(--text));
  font-size: var(--footer-msg-size);
  font-weight: var(--footer-msg-weight);
  letter-spacing: .2px;
}

.footerSub{
  margin-top: 2px;
  color: var(--subtitle, var(--muted));
  font-size: var(--footer-sub-size);
  font-weight: var(--footer-sub-weight);
}

/* Keep your theme footer tint overrides working (update selectors) */
body[data-theme="light"] .footerBar{
  background: rgba(244,247,251,.92);
  border-top-color: rgba(15,23,42,.10);
}
body[data-theme="gruvbox-dark"] .footerBar{
  background: rgba(40,40,40,.92);
  border-top-color: rgba(80,73,69,.55);
}
body[data-theme="gruvbox-light"] .footerBar{
  background: rgba(251,241,199,.92);
  border-top-color: rgba(102,92,84,.28);
}

    }
    body[data-theme="light"] footer{
      background: rgba(244,247,251,.92);
      border-top-color: rgba(15,23,42,.10);
    }
    body[data-theme="gruvbox-dark"] footer{
      background: rgba(40,40,40,.92);
      border-top-color: rgba(80,73,69,.55);
    }
    body[data-theme="gruvbox-light"] footer{
      background: rgba(251,241,199,.92);
      border-top-color: rgba(102,92,84,.28);
    }

    /* Formula helpers */
    .formulaGroup{ display: grid; gap: 8px; }
    .f-label{ color: var(--text); font-weight: 900; }
    .f-var1{ color: var(--f-var1); }
    .f-var2{ color: var(--f-var2); }
    .f-var3{ color: var(--f-var3); }
    .f-const{ color: var(--f-const); }

    /* ===== Additional theme accents (beyond variables) ===== */

    /* Focus ring per theme (uses existing focus vars) */
    body[data-theme="nord"]{ --focus-border: rgba(136,192,208,.85); --focus-ring: rgba(136,192,208,.18); --f-var1:#a3be8c; --f-var2:#ebcb8b; --f-var3:#88c0d0; --f-const:#81a1c1; }
    body[data-theme="tokyo-night"]{ --focus-border: rgba(122,162,247,.85); --focus-ring: rgba(122,162,247,.18); --f-var1:#9ece6a; --f-var2:#e0af68; --f-var3:#7aa2f7; --f-const:#a9b1d6; }
    body[data-theme="dracula"]{ --focus-border: rgba(189,147,249,.85); --focus-ring: rgba(189,147,249,.18); --f-var1:#50fa7b; --f-var2:#f1fa8c; --f-var3:#bd93f9; --f-const:#6272a4; }
    body[data-theme="solarized-dark"]{ --focus-border: rgba(38,139,210,.85); --focus-ring: rgba(38,139,210,.16); --f-var1:#859900; --f-var2:#b58900; --f-var3:#268bd2; --f-const:#93a1a1; }
    body[data-theme="solarized-light"]{ --focus-border: rgba(38,139,210,.85); --focus-ring: rgba(38,139,210,.14); --f-var1:#859900; --f-var2:#b58900; --f-var3:#268bd2; --f-const:#586e75; }
    body[data-theme="catppuccin-mocha"]{ --focus-border: rgba(137,180,250,.85); --focus-ring: rgba(137,180,250,.18); --f-var1:#a6e3a1; --f-var2:#f9e2af; --f-var3:#89b4fa; --f-const:#a6adc8; }
    body[data-theme="catppuccin-latte"]{ --focus-border: rgba(30,102,245,.85); --focus-ring: rgba(30,102,245,.14); --f-var1:#40a02b; --f-var2:#df8e1d; --f-var3:#1e66f5; --f-const:#6c6f85; }
    body[data-theme="amber"]{ --focus-border: rgba(251,191,36,.85); --focus-ring: rgba(251,191,36,.18); --f-var1:#84cc16; --f-var2:#fbbf24; --f-var3:#f59e0b; --f-const:rgba(252,211,77,.90); }
    body[data-theme="high-contrast"]{ --focus-border: rgba(255,255,255,.95); --focus-ring: rgba(255,255,255,.22); --f-var1:#ffffff; --f-var2:#ffffff; --f-var3:#ffffff; --f-const:#ffffff; }
    body[data-theme="mono"]{ --focus-border: rgba(17,24,39,.85); --focus-ring: rgba(17,24,39,.10); --f-var1:#111827; --f-var2:#111827; --f-var3:#111827; --f-const:#374151; }

    /* Chevron hover + toggles + buttons per theme */
    body[data-theme="nord"] summary:hover .chev{ border-color: rgba(136,192,208,.85); }
    body[data-theme="tokyo-night"] summary:hover .chev{ border-color: rgba(122,162,247,.85); }
    body[data-theme="dracula"] summary:hover .chev{ border-color: rgba(189,147,249,.85); }
    body[data-theme="solarized-dark"] summary:hover .chev,
    body[data-theme="solarized-light"] summary:hover .chev{ border-color: rgba(38,139,210,.85); }
    body[data-theme="catppuccin-mocha"] summary:hover .chev{ border-color: rgba(137,180,250,.85); }
    body[data-theme="catppuccin-latte"] summary:hover .chev{ border-color: rgba(30,102,245,.85); }
    body[data-theme="amber"] summary:hover .chev{ border-color: rgba(251,191,36,.85); }
    body[data-theme="high-contrast"] summary:hover .chev{ border-color: rgba(255,255,255,.95); }
    body[data-theme="mono"] summary:hover .chev{ border-color: rgba(17,24,39,.65); }

    body[data-theme="nord"] .toggle.on{ background: rgba(136,192,208,.22); border-color: rgba(136,192,208,.45); }
    body[data-theme="tokyo-night"] .toggle.on{ background: rgba(122,162,247,.22); border-color: rgba(122,162,247,.45); }
    body[data-theme="dracula"] .toggle.on{ background: rgba(189,147,249,.22); border-color: rgba(189,147,249,.45); }
    body[data-theme="solarized-dark"] .toggle.on,
    body[data-theme="solarized-light"] .toggle.on{ background: rgba(38,139,210,.20); border-color: rgba(38,139,210,.42); }
    body[data-theme="catppuccin-mocha"] .toggle.on{ background: rgba(137,180,250,.22); border-color: rgba(137,180,250,.45); }
    body[data-theme="catppuccin-latte"] .toggle.on{ background: rgba(30,102,245,.16); border-color: rgba(30,102,245,.35); }
    body[data-theme="amber"] .toggle.on{ background: rgba(251,191,36,.22); border-color: rgba(251,191,36,.45); }
    body[data-theme="high-contrast"] .toggle.on{ background: rgba(255,255,255,.20); border-color: rgba(255,255,255,.55); }
    body[data-theme="mono"] .toggle.on{ background: rgba(17,24,39,.12); border-color: rgba(17,24,39,.25); }

    body[data-theme="nord"] button{ border-color: rgba(94,129,172,.40); background: linear-gradient(135deg, rgba(136,192,208,.22), rgba(136,192,208,.10)); }
    body[data-theme="tokyo-night"] button{ border-color: rgba(122,162,247,.40); background: linear-gradient(135deg, rgba(122,162,247,.22), rgba(122,162,247,.10)); }
    body[data-theme="dracula"] button{ border-color: rgba(189,147,249,.40); background: linear-gradient(135deg, rgba(189,147,249,.22), rgba(189,147,249,.10)); }
    body[data-theme="solarized-dark"] button,
    body[data-theme="solarized-light"] button{ border-color: rgba(38,139,210,.32); background: linear-gradient(135deg, rgba(38,139,210,.18), rgba(38,139,210,.08)); }
    body[data-theme="catppuccin-mocha"] button{ border-color: rgba(137,180,250,.40); background: linear-gradient(135deg, rgba(137,180,250,.20), rgba(137,180,250,.09)); }
    body[data-theme="catppuccin-latte"] button{ border-color: rgba(30,102,245,.28); background: linear-gradient(135deg, rgba(30,102,245,.14), rgba(30,102,245,.06)); }
    body[data-theme="amber"] button{ border-color: rgba(251,191,36,.34); background: linear-gradient(135deg, rgba(251,191,36,.20), rgba(251,191,36,.09)); }
    body[data-theme="high-contrast"] button{ border-color: rgba(255,255,255,.65); background: rgba(255,255,255,.10); box-shadow: none; }
    body[data-theme="mono"] button{ border-color: rgba(17,24,39,.22); background: rgba(17,24,39,.06); box-shadow: none; }

    /* Read-only input styling for other light themes */
    body[data-theme="solarized-light"] input[readonly],
    body[data-theme="catppuccin-latte"] input[readonly],
    body[data-theme="mono"] input[readonly]{
      background: rgba(17,24,39,.04);
      border-color: rgba(17,24,39,.18);
      color: var(--muted);
    }

    /* Footer tint per theme */
    body[data-theme="nord"] footer{ background: rgba(46,52,64,.92); border-top-color: rgba(76,86,106,.55); }
    body[data-theme="tokyo-night"] footer{ background: rgba(26,27,38,.92); border-top-color: rgba(65,72,104,.55); }
    body[data-theme="dracula"] footer{ background: rgba(40,42,54,.92); border-top-color: rgba(98,114,164,.45); }
    body[data-theme="solarized-dark"] footer{ background: rgba(0,43,54,.92); border-top-color: rgba(88,110,117,.45); }
    body[data-theme="solarized-light"] footer{ background: rgba(253,246,227,.92); border-top-color: rgba(147,161,161,.45); }
    body[data-theme="catppuccin-mocha"] footer{ background: rgba(30,30,46,.92); border-top-color: rgba(88,91,112,.55); }
    body[data-theme="catppuccin-latte"] footer{ background: rgba(239,241,245,.92); border-top-color: rgba(156,160,176,.40); }
    body[data-theme="amber"] footer{ background: rgba(11,10,6,.92); border-top-color: rgba(251,191,36,.22); }
    body[data-theme="high-contrast"] footer{ background: rgba(0,0,0,.98); border-top-color: rgba(255,255,255,.35); }
    body[data-theme="mono"] footer{ background: rgba(246,246,246,.92); border-top-color: rgba(17,24,39,.18); }
</style>
</head>

<body data-density="comfort">
<main>

  <div class="appHeaderImage">
    <img id="headerLogo" src="images/resiniqhead.png" alt="ResinIQ">
  </div>

  <!-- 1) LINE SETUP -->
  <details class="block card" id="lineSetupBlock">
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Setup</div>
          <div class="layerMeta">Line Setup and App Settings</div>
        </div>
      </div>
      <span class="pill">Setup</span>
    </summary>

    <div class="blockBody">
      <div class="grid3">
        <div>
          <label for="lineRate">Line rate (lb/hr)</label>
          <input id="lineRate" type="text" inputmode="decimal" placeholder="0" value="0" />
          <div class="tiny">Example: 1200</div>
        </div>

        <div>
          <label for="gauge">Gauge (mil)</label>
          <input id="gauge" type="text" inputmode="decimal" placeholder="0" value="0" />
          <div class="tiny">Only necessary if you need layer thickness.</div>
        </div>

        <div>
          <label for="lineType">Line type</label>
          <select id="lineType">
            <option value="1">1-layer</option>
            <option value="3" selected>3-layer</option>
            <option value="5">5-layer</option>
          </select>
        </div>
      </div>

      <div class="grid3 mt10">
        <div>
          <label for="changeoverTime">Changeover time (deadline)</label>
          <input id="changeoverTime" type="time" />
        </div>

        <div>
          <label for="densitySel">View</label>
          <select id="densitySel">
            <option value="comfort" selected>Comfort</option>
            <option value="compact">Compact</option>
            <option value="dense">Dense</option>
          </select>
        </div>

        <div>
          <label for="themeSel">Theme</label>
          <select id="themeSel">
                        <option value="dark" selected>Dark</option>
            <option value="light">Light</option>
            <option value="gruvbox-dark">Gruvbox Dark</option>
            <option value="gruvbox-light">Gruvbox Light</option>
            <option value="nord">Nord</option>
            <option value="tokyo-night">Tokyo Night</option>
            <option value="dracula">Dracula</option>
            <option value="solarized-dark">Solarized Dark</option>
            <option value="solarized-light">Solarized Light</option>
            <option value="catppuccin-mocha">Catppuccin Mocha</option>
            <option value="catppuccin-latte">Catppuccin Latte</option>
            <option value="amber">Amber</option>
            <option value="high-contrast">High Contrast</option>
            <option value="mono">Monochrome</option>
          </select>
        </div>
      </div>

      <!-- Nested: weights -->
      <details class="block" id="weightsBlock">
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerTitle" style="font-size:13px">Hopper weights</div>
              <div class="layerMeta">Amount of resin stored in receiver hopper</div>
            </div>
          </div>
          <span class="pill">Weights</span>
        </summary>

        <div class="blockBody">
          <div class="muted">
            Hoppers hold volume, not weight. So this is a bit of guesswork. A bucket of silo resin typically weighs 25lbs for reference.
          </div>
          <div id="weightsArea" class="weightsGrid mt10"></div>
        </div>
      </details>

      <!-- Nested: offsets -->
      <details class="block" id="offsetsBlock">
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerTitle" style="font-size:13px">Offsets</div>
              <div class="layerMeta">Downcomer offset minutes</div>
            </div>
          </div>
          <span class="pill">Offsets</span>
        </summary>

        <div class="blockBody">
          <div class="muted">Adds time for downcomer run-down.</div>
          <div id="offsetInputs" class="gridAuto mt10"></div>
        </div>
      </details>

      <div id="statusBox"></div>
    </div>
  </details>

  <!-- 2) HOPPER PERCENTAGES -->
  <details class="block card" id="splitsBlock">
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Hopper Percentages</div>
          <div class="layerMeta">Set layer and hopper % - Toggle Tracking</div>
        </div>
      </div>
      <span class="pill">Percentages</span>
    </summary>

    <div class="blockBody">
      <div class="muted">Layer rows include Layer % in the header. Hopper rows are labeled A1, A2, etc.</div>
      <div id="splitsArea" class="mt10 gap10"></div>
    </div>
  </details>

  <!-- 3) RESULTS -->
  <details class="block card" id="resultsBlock" open>
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Run-Down Timeline</div>
          <div class="layerMeta">Only tracked hoppers • Sorted by upcoming time</div>
        </div>
      </div>
      <span class="pill">Live</span>
    </summary>
    <div class="blockBody">
      <div class="muted">Sorted by upcoming time (Start by if changeover is set; otherwise Time to empty).</div>
      <div id="resultsArea" class="resultGrid mt10"></div>
    </div>
  </details>

  <!-- 4) RESIN TOTALS -->
  <details class="block card" id="resinCalcBlock">
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Used Resin Totals</div>
          <div class="layerMeta">Totals by resin name</div>
        </div>
      </div>
      <span class="pill">Calc</span>
    </summary>

    <div class="blockBody">
      <div class="muted">Enter total pounds used at end of job.</div>

      <div class="grid2 mt10">
        <div>
          <label for="prodResinLb">Production Resin (lb)</label>
          <input id="prodResinLb" type="text" inputmode="decimal" placeholder="0" value="0" />
        </div>
        <div>
          <label for="scrapResinLb">Scrap Resin (lb)</label>
          <input id="scrapResinLb" type="text" inputmode="decimal" placeholder="0" value="0" />
        </div>
      </div>

      <div id="resinCalcSummary" class="mt10"></div>
      <div id="resinCalcResults" class="calcTable"></div>
    </div>
  </details>

  <!-- 5) RECIPES -->
  <details class="block card" id="recipesBlock">
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Line Configurations</div>
          <div class="layerMeta">Save • load • export • import</div>
        </div>
      </div>
      <span class="pill">Configs</span>
    </summary>

    <div class="blockBody">
      <div class="muted">Save/load typical setups. Export/import JSON for sharing.</div>

      <div class="grid2 mt10">
        <div>
          <label for="configName">Config name</label>
          <input id="configName" type="text" placeholder="e.g. Line 9 typical" />
        </div>
        <div>
          <label for="savedConfigs">Saved configs</label>
          <select id="savedConfigs"></select>
        </div>
      </div>

      <div class="grid2 mt10">
        <button id="saveConfigBtn" type="button">Save / Update config</button>
        <button id="loadConfigBtn" type="button" class="secondary">Load selected config</button>
      </div>

      <div class="grid2 mt10">
        <button id="renameConfigBtn" type="button" class="secondary">Rename selected</button>
        <button id="deleteConfigBtn" type="button" class="danger">Delete selected</button>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <button id="exportConfigBtn" type="button" class="secondary">Export selected (copy JSON)</button>
        <button id="importConfigBtn" type="button" class="secondary">Import JSON (paste)</button>
      </div>

      <div id="importArea" class="hide mt10">
        <label for="importJson">Paste JSON here</label>
        <textarea id="importJson" placeholder='{"name":"Line 9 typical","payload":{...}}'></textarea>
        <div class="grid2 mt10">
          <button id="doImportBtn" type="button">Import now</button>
          <button id="cancelImportBtn" type="button" class="secondary">Cancel</button>
        </div>
      </div>

      <div id="recipeStatus" class="mt10"></div>
    </div>
  </details>

  <!-- 6) INFO -->
  <details class="block card" id="infoBlock">
    <summary>
      <div class="sumLeft">
        <div class="chev"></div>
        <div style="min-width:0">
          <div class="layerTitle">Documentation</div>
          <div class="layerMeta">Formulas • changelog • notes</div>
        </div>
      </div>
      <span class="pill">Help</span>
    </summary>

    <div class="blockBody">
      <!-- 6.1 Operator formulas -->
      <details class="block" id="formulasBlock">
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerTitle" style="font-size:13px">Operator formulas</div>
              <div class="layerMeta">How times are calculated</div>
            </div>
          </div>
          <span class="pill">Math</span>
        </summary>

        <div class="blockBody">
          <div class="muted">Common formulas used.</div>

          <div class="hr"></div>

          <div class="mono" style="line-height:1.7; font-size: var(--font-small);">
            <div class="formulaGroup">
              <div class="mono formula-line">
                <span class="f-label">• Line output (lb/hr)</span>
                =
                <span class="f-var1">Width</span>
                ×
                <span class="f-var2">Line Speed</span>
                ×
                <span class="f-var3">Gauge</span>
                ×
                <span class="f-const">0.048</span>
              </div>

              <div class="mono formula-line">
                <span class="f-label">• Pounds per Thousandths (Width Based)</span>
                =
                <span class="f-var1">Width</span>
                ×
                <span class="f-var3">Gauge</span>
                ×
                <span class="f-const">0.8</span>
              </div>

              <div class="mono formula-line">
                <span class="f-label">• Pounds per Thousandths (Roll Based)</span>
                =
                <span class="f-var1">Max roll weight</span>
                ×
                <span class="f-var2">Number of rolls</span>
                ÷
                <span class="f-var3">Thousands of feet</span>
              </div>

              <div class="mono formula-line">
                <span class="f-label">• Short roll footage</span>
                =
                <span class="f-var1">Short roll weight</span>
                ×
                <span class="f-var3">Target footage</span>
                ÷
                <span class="f-var2">Last good roll weight</span>
              </div>

              <div class="mono formula-line">
                <span class="f-label">• Weight adjustment (new line speed)</span>
                =
                <span class="f-var1">Wrong weight</span>
                ×
                <span class="f-var2">Line speed</span>
                ÷
                <span class="f-var3">Target weight</span>
              </div>

              <div class="mono formula-line">
                <span class="f-label">• Line speed</span>
                =
                <span class="f-var1">Line Output (lb/hr)</span>
                ÷
                <span class="f-var2">(Width</span>
                ×
                <span class="f-var3">Gauge</span>
                ×
                <span class="f-var1">0.048)</span>
              </div>
            </div>
          </div>

          <div class="tiny">...</div>
        </div>
      </details>

      <!-- 6.2 Changelog -->
      <details class="block" id="changelogBlock">
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerTitle" style="font-size:13px">Changelog</div>
              <div class="layerMeta">What changed between versions</div>
            </div>
          </div>
          <span class="pill">Log</span>
        </summary>

        <div class="blockBody">
          <div class="muted">What's new.</div>
          <div class="hr"></div>

          <div class="mono" style="line-height:1.7; font-size: var(--font-small);">
            <div><strong>0.11</strong> — Layer cards now display thickness. Must set gauge in Setup.</div>
            <div><strong>0.10</strong> — Added more themes (Nord, Tokyo Night, Dracula, Solarized, Catppuccin, Amber, High Contrast, Mono).</div>
            <div><strong>0.09</strong> — Light and dark themes added to setup.</div>
            <div><strong>0.08</strong> — Added ability to name resins in each hopper.</div>
            <div><strong>0.07</strong> — Added resin calculator. Uses resin names.</div>
            <div><strong>0.06</strong> — Added formulas under new Info section.</div>
          </div>

          <div class="tiny">..</div>
        </div>
      </details>

      <!-- 6.3 Notes -->
      <details class="block" id="notesBlock">
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerTitle" style="font-size:13px">Notes</div>
              <div class="layerMeta">Tips about this tool</div>
            </div>
          </div>
          <span class="pill">Notes</span>
        </summary>

        <div class="blockBody">
          <div class="muted">Practical.</div>
          <div class="hr"></div>

          <div class="mono" style="line-height:1.7; font-size: var(--font-small);">
            <div>• Hoppers hold volume, not weight. If you “time 60 lb” but the resin is denser, you’ll still have resin left.</div>
            <div>• This matters most for silo resins and big changeovers. Additives are usually closer if you know approximate density.</div>
            <div>• If you want better accuracy: weigh a bucket of each common resin and write it down.</div>
          </div>

          <div class="tiny">..</div>
        </div>
      </details>
    </div>
  </details>

</main>

<footer class="footerBar">
  <div id="footerMsg" class="footerMsg">—</div>
  <div id="footerSub" class="footerSub">—</div>
</footer>

<script>
  const APP_VERSION = "0.11";

  const LS_SESSION_KEY = "resinTimer.session.v0.09";
  const LS_CONFIGS_KEY  = "resinTimer.configs.v0.09";

  const DETAILS_IDS = [
    "lineSetupBlock",
    "weightsBlock",
    "offsetsBlock",
    "splitsBlock",
    "resultsBlock",
    "resinCalcBlock",
    "recipesBlock",
    "infoBlock",
    "formulasBlock",
    "changelogBlock",
    "notesBlock"
  ];

  const HOPPERS_PER_LAYER = 6;

  const state = {
    lineRate: 0,
    lineType: 3,
    changeoverTime: "",
    offsets: {},
    layers: [],
    prodResinLb: 0,
    scrapResinLb: 0,
    density: "comfort",
    theme: "dark",
    gauge: 0
  };

  const $ = (id) => document.getElementById(id);

  function clampNum(x){
    if (x === null || x === undefined) return 0;
    const s = String(x).trim();
    if (s === "") return 0;
    const cleaned = s.replace(/,/g, "");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }
  function normName(s){ return String(s || "").trim().replace(/\\s+/g, " "); }
  function keyName(s){ return normName(s).toUpperCase(); }
  function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
  function fmtNum(n, d=2){ return Number.isFinite(n) ? n.toFixed(d) : "—"; }
  function fmtTrim(n, d=3){
    if (!Number.isFinite(n)) return "—";
    return n.toFixed(d).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1");
  }


  function hoursToHHMM(h){
    if (!Number.isFinite(h) || h < 0) return "—";
    const total = Math.floor(h*60 + 0.5);
    const hh = Math.floor(total/60);
    const mm = total % 60;
    return `${hh}h ${String(mm).padStart(2,"0")}m`;
  }
  function minutesToHHMM(mins){
    if (!Number.isFinite(mins) || mins < 0) return "—";
    const total = Math.floor(mins + 0.5);
    const hh = Math.floor(total/60);
    const mm = total % 60;
    return `${hh}h ${String(mm).padStart(2,"0")}m`;
  }

  function parseChangeoverDate(hhmm){
  if (!hhmm) return null;

  const s = String(hhmm).trim();

  // Accept "H:MM", "HH:MM", and optional seconds "HH:MM:SS"
  const m = /^(\d{1,2}):(\d{2})(?::(\d{2}))?$/.exec(s);
  if (!m) return null;

  const hh = Number(m[1]), mm = Number(m[2]);
  if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;

  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);

  // If the time is already in the past (give a small grace), assume it's tomorrow
  if (d.getTime() < now.getTime() - 60*1000) d.setDate(d.getDate() + 1);

  return d;
}
  function fmtTime(dateObj, baseDateObj){
    if (!dateObj) return "—";
    const t = dateObj.toLocaleTimeString([], {hour:"numeric", minute:"2-digit"});
    if (!baseDateObj) return t;
    const sameDay =
      dateObj.getFullYear()===baseDateObj.getFullYear() &&
      dateObj.getMonth()===baseDateObj.getMonth() &&
      dateObj.getDate()===baseDateObj.getDate();
    return sameDay ? t : `${t} (+1d)`;
  }

  function recomputeAutoH1(layer){
    // Sum hoppers 2-6; H1 = 100 - sum
    let sumOthers = 0;
    for (let i = 1; i < HOPPERS_PER_LAYER; i++){
      sumOthers += clampNum(layer.hoppers[i].pct);
    }
    let h1 = 100 - sumOthers;
    if (h1 < 0) h1 = 0;
    if (h1 > 100) h1 = 100;
    layer.hoppers[0].pct = h1;
  }

  function setStatus(html){
    const el = $("statusBox");
    if (el) el.innerHTML = html || "";
  }
  function statusMessage(messages){
    if (!messages.length) return "";
    const hasBad = messages.some(m=>m.type==="bad");
    const hasWarn = messages.some(m=>m.type==="warn");
    const cls = hasBad ? "status bad" : (hasWarn ? "status" : "status ok");
    const title = hasBad ? "Fix before trusting results:" : (hasWarn ? "Heads up:" : "Looks good:");
    const items = messages.map(m=>`<li>${m.text}</li>`).join("");
    return `<div class="${cls}"><div style="font-weight:950;margin-bottom:6px">${title}</div><ul>${items}</ul></div>`;
  }

  function getLayerNamesForType(lineType){
    if (lineType === 1) return ["A"];
    if (lineType === 5) return ["A","B","C","D","E"];
    return ["A","B","C"];
  }
  function getLayerCopyRules(lineType){
    if (lineType === 3) return { "C": "A" };
    if (lineType === 5) return { "D": "B", "E": "A" };
    return {};
  }

  function ensureLayers(){
    const names = getLayerNamesForType(state.lineType);
    const prevByName = {};
    (state.layers || []).forEach(L => { if (L?.name) prevByName[L.name] = L; });

    state.layers = names.map(name => {
      const p = prevByName[name];
      if (p){
        return {
          name,
          layerPct: clampNum(p.layerPct),
          hoppers: Array.from({length:HOPPERS_PER_LAYER}, (_,i)=>{
            const h = p.hoppers?.[i] || {};
            return {
              pct: clampNum(h.pct),
              weight: clampNum(h.weight),
              resinName: normName(h.resinName || ""),
              track: !!h.track,
              pumpOff: !!h.pumpOff
            };
          })
        };
      }
      return {
        name,
        layerPct: 0,
        hoppers: Array.from({length:HOPPERS_PER_LAYER}, (_,i)=>({
          pct: i === 0 ? 100 : 0,
          weight: 0,
          resinName: "",
          track: false,
          pumpOff: false
        }))
      };
    });

    state.layers.forEach(recomputeAutoH1);

    const nextOffsets = {};
    names.forEach(n => nextOffsets[n] = clampNum(state.offsets?.[n] ?? 0));
    state.offsets = nextOffsets;
  }

  function snapshotPayload(){
    const blocksOpen = {};
    DETAILS_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (el && typeof el.open === "boolean") blocksOpen[id] = !!el.open;
    });

    return {
      version: APP_VERSION,
      lineRate: state.lineRate,
      lineType: state.lineType,
      changeoverTime: state.changeoverTime,
      offsets: state.offsets,
      layers: state.layers,
      prodResinLb: state.prodResinLb,
      scrapResinLb: state.scrapResinLb,
      density: state.density,
      theme: state.theme,
      gauge: state.gauge,
      blocksOpen
    };
  }

  function applyTheme(t){
    const allowed = new Set(["dark","light","gruvbox-dark","gruvbox-light","nord","tokyo-night","dracula","solarized-dark","solarized-light","catppuccin-mocha","catppuccin-latte","amber","high-contrast","mono"]);
    const theme = allowed.has(String(t)) ? String(t) : "dark";

    document.body.setAttribute("data-theme", theme);

    const sel = $("themeSel");
    if (sel) sel.value = theme;

    state.theme = theme;

    // Logo per theme
    const logo = $("headerLogo");
    if (logo){
      // Keep your dedicated Gruvbox header images; map the rest to light/dark
      const lightish = new Set(["light","gruvbox-light","solarized-light","catppuccin-latte","mono"]);
      let src = lightish.has(theme) ? "images/resiniqhead-l.png" : "images/resiniqhead.png";

      if (theme === "gruvbox-light") src = "images/resiniqhead-gbl.png";
      if (theme === "gruvbox-dark")  src = "images/resiniqhead-gbd.png";

      logo.src = src;
    }
}

  function applyDensity(d){
    const allowed = new Set(["comfort","compact","dense"]);
    const density = allowed.has(String(d)) ? String(d) : "comfort";
    document.body.setAttribute("data-density", density);
    const sel = $("densitySel");
    if (sel) sel.value = density;
    state.density = density;
  }

  function applyPayload(payload, {rebuildUI=true} = {}){
    if (!payload || typeof payload !== "object") return;

    state.lineRate = clampNum(payload.lineRate);
    if ("gauge" in payload) state.gauge = clampNum(payload.gauge);
    state.lineType = [1,3,5].includes(Number(payload.lineType)) ? Number(payload.lineType) : 3;
    state.changeoverTime = payload.changeoverTime || "";
    state.offsets = payload.offsets || {};
    state.prodResinLb = clampNum(payload.prodResinLb);
    state.scrapResinLb = clampNum(payload.scrapResinLb);

    applyTheme(payload.theme || "dark");
    applyDensity(payload.density || "comfort");
    $("lineRate").value = String(state.lineRate);
    const g = $("gauge");
    if (g) g.value = String(state.gauge);

    $("lineType").value = String(state.lineType);
    $("changeoverTime").value = state.changeoverTime;


    const names = getLayerNamesForType(state.lineType);
    const oldLayers = Array.isArray(payload.layers) ? payload.layers : [];
    state.layers = names.map(name => {
      const found = oldLayers.find(x => x?.name === name) || {};
      const layerPct = clampNum(found.layerPct);
      const hoppers = Array.from({length:HOPPERS_PER_LAYER}, (_,i)=>{
        const fh = found?.hoppers?.[i] || {};
        return {
          pct: clampNum(fh.pct),
          weight: clampNum(fh.weight),
          resinName: normName(fh.resinName || ""),
          track: !!fh.track,
          pumpOff: !!fh.pumpOff
        };
      });
      return { name, layerPct, hoppers };
    });

    const nextOffsets = {};
    names.forEach(n => nextOffsets[n] = clampNum(state.offsets?.[n] ?? 0));
    state.offsets = nextOffsets;

    const lineRateEl = $("lineRate");
    if (lineRateEl) lineRateEl.value = String(state.lineRate);
    const lineTypeEl = $("lineType");
    if (lineTypeEl) lineTypeEl.value = String(state.lineType);

    const coEl = $("changeoverTime");
    if (coEl) coEl.value = state.changeoverTime;

    if (rebuildUI) rebuildUIFromState(payload);
    else validateAndCompute();
  }

  function saveSession(){
    try{ localStorage.setItem(LS_SESSION_KEY, JSON.stringify(snapshotPayload())); }catch(e){}
  }
  function loadSession(){
    try{
      const raw = localStorage.getItem(LS_SESSION_KEY);
      if (!raw) return false;
      applyPayload(JSON.parse(raw), {rebuildUI:true});
      return true;
    }catch(e){ return false; }
  }
  function clearSession(){
    try{ localStorage.removeItem(LS_SESSION_KEY); }catch(e){}
  }

  // Recipes
  function readConfigs(){
    try{
      const raw = localStorage.getItem(LS_CONFIGS_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){ return {}; }
  }
  function writeConfigs(obj){
    try{ localStorage.setItem(LS_CONFIGS_KEY, JSON.stringify(obj)); }catch(e){}
  }
  function recipeStatus(msg, type="ok"){
    const el = $("recipeStatus");
    if (!el) return;
    const cls = type==="bad" ? "status bad" : (type==="warn" ? "status" : "status ok");
    el.innerHTML = `<div class="${cls}"><div style="font-weight:950">${msg}</div></div>`;
    setTimeout(()=>{ el.innerHTML = ""; }, 4500);
  }
  function refreshConfigDropdown(selectName){
    const configs = readConfigs();
    const sel = $("savedConfigs");
    if (!sel) return;

    const names = Object.keys(configs).sort((a,b)=>a.localeCompare(b));
    sel.innerHTML = "";
    if (names.length === 0){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "— none saved —";
      sel.appendChild(o);
      return;
    }
    names.forEach(n=>{
      const o = document.createElement("option");
      o.value = n;
      o.textContent = n;
      sel.appendChild(o);
    });
    if (selectName && names.includes(selectName)) sel.value = selectName;
  }

  function normalizeConfigName(name){ return (name || "").trim().replace(/\\s+/g, " "); }

  function saveNamedConfig(){
    const name = normalizeConfigName($("configName")?.value);
    if (!name){ recipeStatus("Please enter a config name first.", "warn"); return; }
    const configs = readConfigs();
    configs[name] = snapshotPayload();
    writeConfigs(configs);
    refreshConfigDropdown(name);
    recipeStatus(`Saved config: "${name}"`, "ok");
  }
  function loadSelectedConfig(){
    const sel = $("savedConfigs")?.value;
    if (!sel){ recipeStatus("No config selected.", "warn"); return; }
    const configs = readConfigs();
    const payload = configs[sel];
    if (!payload){ recipeStatus("Selected config not found.", "bad"); return; }
    applyPayload(payload, {rebuildUI:true});
    const cn = $("configName"); if (cn) cn.value = sel;
    recipeStatus(`Loaded config: "${sel}"`, "ok");
    saveSession();
  }
  function renameSelectedConfig(){
    const oldName = $("savedConfigs")?.value;
    if (!oldName){ recipeStatus("No config selected to rename.", "warn"); return; }
    const newName = normalizeConfigName($("configName")?.value);
    if (!newName){ recipeStatus("Enter the new name in the Config name field.", "warn"); return; }
    const configs = readConfigs();
    if (!configs[oldName]){ recipeStatus("Selected config not found.", "bad"); return; }
    if (oldName !== newName && configs[newName]){
      recipeStatus("A config with that name already exists.", "warn");
      return;
    }
    configs[newName] = configs[oldName];
    delete configs[oldName];
    writeConfigs(configs);
    refreshConfigDropdown(newName);
    recipeStatus(`Renamed "${oldName}" → "${newName}"`, "ok");
  }
  function deleteSelectedConfig(){
    const name = $("savedConfigs")?.value;
    if (!name){ recipeStatus("No config selected to delete.", "warn"); return; }
    if (!confirm(`Delete config "${name}"?`)) return;
    const configs = readConfigs();
    delete configs[name];
    writeConfigs(configs);
    refreshConfigDropdown();
    recipeStatus(`Deleted "${name}"`, "ok");
  }

  async function copyTextToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(e){
      try{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        return true;
      }catch(e2){ return false; }
    }
  }

  async function exportSelectedConfig(){
    const name = $("savedConfigs")?.value || normalizeConfigName($("configName")?.value);
    if (!name){ recipeStatus("Select a config (or type a name) to export.", "warn"); return; }
    const configs = readConfigs();
    const payload = configs[name] || snapshotPayload();
    const wrapper = { name, exportedAt: new Date().toISOString(), version: APP_VERSION, payload };
    const ok = await copyTextToClipboard(JSON.stringify(wrapper, null, 2));
    recipeStatus(ok ? `Copied JSON for "${name}" to clipboard.` : "Could not copy to clipboard.", ok ? "ok" : "warn");
  }

  function showImportUI(show){
    const area = $("importArea");
    if (!area) return;
    area.classList.toggle("hide", !show);
    if (show) $("importJson")?.focus();
  }
  function doImport(){
    const raw = $("importJson")?.value?.trim() || "";
    if (!raw){ recipeStatus("Paste JSON first.", "warn"); return; }
    let obj;
    try{ obj = JSON.parse(raw); }
    catch(e){ recipeStatus("Invalid JSON.", "bad"); return; }

    let name = normalizeConfigName(obj?.name);
    let payload = obj?.payload && typeof obj.payload === "object" ? obj.payload : obj;

    if (!name) name = normalizeConfigName(prompt("Name for this imported config:", "Imported config") || "");
    if (!name){ recipeStatus("Import canceled (no name).", "warn"); return; }

    const configs = readConfigs();
    configs[name] = payload;
    writeConfigs(configs);
    refreshConfigDropdown(name);
    const cn = $("configName"); if (cn) cn.value = name;

    const loadNow = confirm(`Imported "${name}". Load it now? (This will overwrite current inputs)`);
    if (loadNow){
      applyPayload(payload, {rebuildUI:true});
      saveSession();
    }

    showImportUI(false);
    const ij = $("importJson"); if (ij) ij.value = "";
    recipeStatus(`Imported config: "${name}"`, "ok");
  }

  function renderOffsetInputs(){
    const wrap = $("offsetInputs");
    if (!wrap) return;
    wrap.innerHTML = "";
    state.layers.forEach(L=>{
      const id = `offset_${L.name}`;
      const box = document.createElement("div");
      box.innerHTML = `
        <label for="${id}">Layer ${L.name} offset</label>
        <input id="${id}" type="text" inputmode="numeric" placeholder="0" value="${clampNum(state.offsets[L.name] ?? 0)}" />
      `;
      wrap.appendChild(box);
      box.querySelector("input").addEventListener("input",(e)=>{
        state.offsets[L.name] = clampNum(e.target.value);
        validateAndCompute();
        saveSession();
        updateLayerMetaDisplays();
      });
    });
  }

  function weightId(layerName, hi){ return `w_${layerName}_${hi}`; }
  function renderWeightsArea(){
    const area = $("weightsArea");
    if (!area) return;
    area.innerHTML = "";
    state.layers.forEach(L=>{
      const box = document.createElement("div");
      box.className = "weightsLayer";
      box.innerHTML = `
        <div class="weightsTitle">
          <strong>Layer ${L.name}</strong>
          <span class="pill">Weights</span>
        </div>
        <div id="wg_${L.name}" style="display:grid; gap: var(--gap);"></div>
      `;
      area.appendChild(box);

      const grid = box.querySelector(`#wg_${L.name}`);
      for (let hi=0; hi<HOPPERS_PER_LAYER; hi++){
        const id = weightId(L.name, hi);
        const row = document.createElement("div");
        row.className = "weightsRow";
        row.innerHTML = `
          <div class="mono" style="font-weight:950;">${L.name}${hi+1}</div>
          <input id="${id}" type="text" inputmode="decimal" placeholder="0" value="${clampNum(L.hoppers[hi].weight)}" />
        `;
        grid.appendChild(row);

        row.querySelector("input").addEventListener("input",(e)=>{
          L.hoppers[hi].weight = clampNum(e.target.value);
          validateAndCompute();
          saveSession();
        });
      }
    });
  }

  function renderSplitsArea(){
    const area = $("splitsArea");
    if (!area) return;
    area.innerHTML = "";

    const div = 100;
    const copyRules = getLayerCopyRules(state.lineType);

    function copyLayer(fromName, toName){
      const from = state.layers.find(L=>L.name===fromName);
      const to = state.layers.find(L=>L.name===toName);
      if (!from || !to) return;
      for (let i=0;i<HOPPERS_PER_LAYER;i++){
        to.hoppers[i].pct = clampNum(from.hoppers[i].pct);
        to.hoppers[i].resinName = normName(from.hoppers[i].resinName);
        to.hoppers[i].track = !!from.hoppers[i].track;
      }
      to.layerPct = clampNum(from.layerPct);
    }

    state.layers.forEach((L)=>{
      const det = document.createElement("details");
      det.className = "block";
      det.open = false;

      const layerPctText = `${fmtNum(L.layerPct,2)}%`;
      const off = clampNum(state.offsets?.[L.name] ?? 0);

      const copyFrom = copyRules[L.name];
      const copyBtnHTML = copyFrom
        ? `<button type="button" class="copyBtn" data-copyfrom="${copyFrom}" data-copyto="${L.name}">Copy ${copyFrom} → ${L.name}</button>`
        : "";

      det.innerHTML = `
        <summary>
          <div class="sumLeft">
            <div class="chev"></div>
            <div style="min-width:0">
              <div class="layerPctInline">
                <div class="layerTitle">Layer ${L.name}</div>
                <input
                  id="lp_${L.name}"
                  type="text"
                  inputmode="decimal"
                  placeholder="0"
                  value="${clampNum(L.layerPct)}"
                  aria-label="Layer ${L.name} percent"
                />
              </div>
              <div class="layerMeta"> Thickness: <span class="mono" id="layerThickText_${L.name}">${(clampNum(state.gauge)>0)?`${fmtTrim(clampNum(state.gauge)*(clampNum(L.layerPct)/100),3)} mil`:"—"}</span> • Offset: <span class="mono" id="layerOffText_${L.name}">${fmtNum(off,0)} min</span></div>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            ${copyBtnHTML}
            <span class="pill hide">Splits</span>
          </div>
        </summary>
        <div class="blockBody">
          <div class="hopperList" id="list_${L.name}"></div>
        </div>
      `;
      area.appendChild(det);

      const lpEl = det.querySelector(`#lp_${L.name}`);
      if (lpEl){
        ["click","mousedown","keydown"].forEach(evt =>
          lpEl.addEventListener(evt, (e)=> e.stopPropagation())
        );
        lpEl.addEventListener("input",(e)=>{
          L.layerPct = clampNum(e.target.value);
          validateAndCompute();
          saveSession();
          updateLayerMetaDisplays();
        });
      }

      const copyBtn = det.querySelector(".copyBtn");
      if (copyBtn){
        copyBtn.addEventListener("click",(e)=>{
          e.preventDefault(); e.stopPropagation();
          const from = copyBtn.getAttribute("data-copyfrom");
          const to = copyBtn.getAttribute("data-copyto");
          const ok = confirm(`Copy layer % + splits + resin names + track toggles from Layer ${from} → Layer ${to}?`);
          if (!ok) return;
          copyLayer(from, to);
          renderSplitsArea();
          validateAndCompute();
          saveSession();
        });
        copyBtn.addEventListener("keydown",(e)=>e.stopPropagation());
      }

      const list = det.querySelector(`#list_${L.name}`);

      for (let hi=0; hi<HOPPERS_PER_LAYER; hi++){
        const resinFieldId = `r_${L.name}_${hi}`;
        const pctFieldId = `p_${L.name}_${hi}`;
        const toggleId = `t_${L.name}_${hi}`;

        const row = document.createElement("div");
        row.className = "hopperRow";
        row.innerHTML = `
          <div class="hopperBadge mono">${L.name}${hi+1}</div>
          <input id="${resinFieldId}" class="resinNameInput" type="text" placeholder="Resin name" value="${(L.hoppers[hi].resinName || "").replace(/"/g,'&quot;')}" />
          <input id="${pctFieldId}" class="splitInput" type="text" inputmode="decimal" placeholder="0" value="${clampNum(L.hoppers[hi].pct)}" />
          <div class="trackWrap">
            <span class="trackLabel">Track</span>
            <div id="${toggleId}" class="toggle ${L.hoppers[hi].track ? "on":""}" role="switch" aria-checked="${L.hoppers[hi].track ? "true":"false"}" tabindex="0"></div>
          </div>
        `;
        list.appendChild(row);

        const resinEl = row.querySelector(`#${resinFieldId}`);
        const pctEl = row.querySelector(`#${pctFieldId}`);
        if (hi === 0){
          pctEl.readOnly = true;
          pctEl.title = "Auto (100% minus other hoppers)";
          pctEl.style.opacity = "0.85";
        }

        const togEl = row.querySelector(`#${toggleId}`);

        resinEl.addEventListener("input",(e)=>{
          L.hoppers[hi].resinName = normName(e.target.value);
          renderResinCalculator();
          saveSession();
        });

        pctEl.addEventListener("input",(e)=>{
          if (hi === 0) return;
          L.hoppers[hi].pct = clampNum(e.target.value);

          recomputeAutoH1(L);

          const h1Id = `p_${L.name}_0`;
          const h1El = det.querySelector(`#${h1Id}`);
          if (h1El) h1El.value = String(clampNum(L.hoppers[0].pct));

          validateAndCompute();
          saveSession();
        });

        function toggleTrack(){
          L.hoppers[hi].track = !L.hoppers[hi].track;
          togEl.classList.toggle("on", L.hoppers[hi].track);
          togEl.setAttribute("aria-checked", L.hoppers[hi].track ? "true" : "false");
          validateAndCompute();
          saveSession();
        }
        togEl.addEventListener("click",(e)=>{ e.preventDefault(); toggleTrack(); });
        togEl.addEventListener("keydown",(e)=>{
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleTrack(); }
        });
      }
    });
  }

  function renderResinCalculator(){
    const prod = clampNum(state.prodResinLb);
    const scrap = clampNum(state.scrapResinLb);
    const total = prod + scrap;

    const div = 100;
    const totals = new Map();

    state.layers.forEach((L)=>{
      const layerFrac = clampNum(L.layerPct) / div;
      L.hoppers.forEach((h)=>{
        const name = normName(h.resinName);
        if (!name) return;
        const hopperFrac = clampNum(h.pct) / div;
        if (hopperFrac <= 0) return;
        const lbs = total * layerFrac * hopperFrac;
        if (!Number.isFinite(lbs) || lbs <= 0) return;

        const k = keyName(name);
        if (!totals.has(k)) totals.set(k, { displayName: name, lbs: 0 });
        totals.get(k).lbs += lbs;
      });
    });

    const sumEl = $("resinCalcSummary");
    if (sumEl){
      sumEl.innerHTML = `
        <div class="status ok">
          <div style="font-weight:950;margin-bottom:6px">Resin totals</div>
          <div class="muted">
            Production: <span class="mono">${fmtNum(prod,2)}</span> lb • Scrap: <span class="mono">${fmtNum(scrap,2)}</span> lb •
            Total: <span class="mono">${fmtNum(total,2)}</span> lb
          </div>
        </div>
      `;
    }

    const out = $("resinCalcResults");
    if (!out) return;
    out.innerHTML = "";
    if (total <= 0){
      out.innerHTML = `<div class="muted"></div>`;
      return;
    }
    if (totals.size === 0){
      out.innerHTML = `<div class="muted">Add resin names + splits to see totals here.</div>`;
      return;
    }
    const rows = Array.from(totals.values()).sort((a,b)=>b.lbs - a.lbs);
    rows.forEach(r=>{
      const row = document.createElement("div");
      row.className = "calcRow";
      row.innerHTML = `
        <div class="calcLeft">
          <div class="calcName mono">${r.displayName}</div>
          <div class="calcMeta">Allocated from splits</div>
        </div>
        <div class="mono" style="font-weight:950">${fmtNum(r.lbs,2)} lb</div>
      `;
      out.appendChild(row);
    });
  }

  function updateLayerMetaDisplays(){
    const g = clampNum(state.gauge);
    state.layers.forEach(L=>{
      const pct = clampNum(L.layerPct);

      const pctEl = document.getElementById(`layerPctText_${L.name}`);
      if (pctEl) pctEl.textContent = `${fmtNum(pct,2)}%`;

      const thickEl = document.getElementById(`layerThickText_${L.name}`);
      if (thickEl) thickEl.textContent = (g>0) ? `${fmtTrim(g*(pct/100),3)} mil` : "—";

      const off = clampNum(state.offsets?.[L.name] ?? 0);
      const offEl = document.getElementById(`layerOffText_${L.name}`);
      if (offEl) offEl.textContent = `${fmtNum(off,0)} min`;
    });
  }

  function validateAndCompute(){
    const msgs = [];
    const div = 100;

    if (state.lineRate <= 0) msgs.push({type:"warn", text:"Line rate is 0 — rates/times will be 0."});

    const layerFracs = state.layers.map(L => clampNum(L.layerPct)/div);
    const layerSum = sum(layerFracs);
    if (state.layers.length && Math.abs(layerSum - 1) > 0.0001){
      msgs.push({type:"warn", text:`Layer split sums to ${fmtNum(layerSum*100,2)}% (expected 100%).`});
    }

    const tracked = [];
    state.layers.forEach(L=>L.hoppers.forEach((h,hi)=>{ if (h.track) tracked.push({L,h,hi}); }));
    if (tracked.length === 0){
      msgs.push({type:"warn", text:"No hoppers are tracked. Turn on Track for the hopper(s) you want in Results."});
    } else {
      const missingW = tracked.filter(x=>clampNum(x.h.weight) <= 0).length;
      if (missingW > 0){
        msgs.push({type:"warn", text:`${missingW} tracked hopper(s) are missing weight. Open “Hopper weights” to enter them.`});
      }
    }

    setStatus(statusMessage(msgs));

    const changeoverDate = parseChangeoverDate(state.changeoverTime);
    const flat = [];

    state.layers.forEach((L)=>{
      const layerRate = state.lineRate * (clampNum(L.layerPct)/div);
      const offsetMin = clampNum(state.offsets?.[L.name] ?? 0);

      L.hoppers.forEach((h, hi)=>{
        if (!h.track) return;

        const hopperRate = layerRate * (clampNum(h.pct)/div);
        const weight = clampNum(h.weight);

        let minutesToEmpty = null;
        let totalMinutes = null;
        let startByDate = null;

        let timeText="—", startByText="—", totalRundownText="—";

        if (hopperRate > 0 && weight > 0){
          minutesToEmpty = (weight / hopperRate) * 60;
          totalMinutes = minutesToEmpty + offsetMin;

          timeText = hoursToHHMM(minutesToEmpty/60);
          totalRundownText = minutesToHHMM(totalMinutes);

          if (changeoverDate){
            startByDate = new Date(changeoverDate.getTime() - totalMinutes*60*1000);
            startByText = fmtTime(startByDate, changeoverDate);
          }
        } else if (hopperRate <= 0 && clampNum(h.pct) > 0){
          timeText = "Not feeding";
          startByText = "Not feeding";
        } else {
          timeText = "Missing data";
        }

        flat.push({
          layer: L.name,
          hopperLabel: `${L.name}${hi+1}`,
          resinName: normName(h.resinName),
          weight,
          rate: hopperRate,
          timeText,
          startByText,
          totalRundownText,
          minutesToEmpty,
          totalMinutes,
          startByDate,
          offsetMin,
          pumpOff: !!h.pumpOff,
          _ref: { h }
        });
      });
    });

    renderResultsFlat(flat, changeoverDate);
    updateFooterNext(flat, changeoverDate);
    renderResinCalculator();
    saveSession();
  }

  function renderResultsFlat(flat, changeoverDate){
    const area = $("resultsArea");
    if (!area) return;
    area.innerHTML = "";

    if (flat.length === 0){
      area.innerHTML = `<div class="muted">No tracked hoppers yet. Turn on Track in “Hopper Percentages”.</div>`;
      return;
    }

    flat.sort((a,b)=>{
      if (changeoverDate){
        const ta = a.startByDate ? a.startByDate.getTime() : Infinity;
        const tb = b.startByDate ? b.startByDate.getTime() : Infinity;
        if (ta !== tb) return ta - tb;
      } else {
        const ta = (typeof a.minutesToEmpty === "number" && isFinite(a.minutesToEmpty)) ? a.minutesToEmpty : Infinity;
        const tb = (typeof b.minutesToEmpty === "number" && isFinite(b.minutesToEmpty)) ? b.minutesToEmpty : Infinity;
        if (ta !== tb) return ta - tb;
      }
      if (a.layer !== b.layer) return a.layer.localeCompare(b.layer);
      return a.hopperLabel.localeCompare(b.hopperLabel);
    });

    flat.forEach((h)=>{
      const resinChip = h.resinName ? `<span class="pill mono">${h.resinName}</span>` : `<span class="pill badge-warn">No resin name</span>`;
      const weightChip = h.weight > 0 ? `<span class="muted mono">${fmtNum(h.weight,2)} lb</span>` : `<span class="pill badge-warn">Missing weight</span>`;
      const splitWarn = (h.rate <= 0 && h.weight > 0) ? `<span class="pill badge-warn">Split?</span>` : "";

      const row = document.createElement("div");
      row.className = "resultRow" + (h.pumpOff ? " done" : "");
      row.innerHTML = `
        <div>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <span class="pill mono">Layer ${h.layer}</span>
            <span class="pill mono">${h.hopperLabel}</span>
            ${resinChip}
            ${weightChip}
            ${splitWarn}
          </div>

          <div class="meta">
            Rate: <span class="mono">${fmtNum(h.rate,2)}</span> lb/hr • Offset: <span class="mono">${fmtNum(h.offsetMin,0)}</span> min<br/>
            Time to empty: <span class="mono">${h.timeText}</span> • Total: <span class="mono">${h.totalRundownText}</span>
          </div>
        </div>

        <div style="text-align:right; white-space:nowrap; min-width: 120px;">
          <div class="muted" style="font-size:var(--font-small)">${changeoverDate ? "Start by" : "Soonest"}</div>
          <div style="font-weight:950" class="mono">${changeoverDate ? h.startByText : h.timeText}</div>

          <label class="checkWrap" title="Check when the hopper pump is turned off">
            <input type="checkbox" ${h.pumpOff ? "checked" : ""}>
            Pump off
          </label>
        </div>
      `;

      row.querySelector('input[type="checkbox"]').addEventListener("change",(e)=>{
        h._ref.h.pumpOff = !!e.target.checked;
        saveSession();
        validateAndCompute();
      });

      area.appendChild(row);
    });
  }

  function resetAll(){
    const ok = confirm("Reset all fields?\\n\\nPress OK to reset.\\nPress Cancel to keep current values.");
    if (!ok) return;

    const clearSaved = confirm("Also clear saved session (autosave) data on this device?");
    if (clearSaved) clearSession();

    state.lineRate = 0;
    state.changeoverTime = "";
    state.gauge = 0;
    state.prodResinLb = 0;
    state.scrapResinLb = 0;

    ensureLayers();
    state.layers.forEach(L=>{
      L.layerPct = 0;
      state.offsets[L.name] = 0;
      L.hoppers.forEach((h,i)=>{
        h.pct = (i === 0) ? 100 : 0;
        h.weight = 0;
        h.resinName = "";
        h.track = false;
        h.pumpOff = false;
      });
    });
    state.layers.forEach(recomputeAutoH1);

    const lr = $("lineRate"); if (lr) lr.value = "0";
    const co = $("changeoverTime"); if (co) co.value = "";
    const pr = $("prodResinLb"); if (pr) pr.value = "0";
    const sr = $("scrapResinLb"); if (sr) sr.value = "0";

    rebuildUIFromState();
    saveSession();
  }



  // Focus: select all numeric fields, not resin names
  function selectAllSoon(el){
    if (!el) return;
    if (el.tagName === "SELECT") return;
    if (el.type === "checkbox" || el.type === "radio") return;
    if (el.readOnly || el.disabled) return;
    setTimeout(()=>{
      try{
        el.focus({preventScroll:true});
        if (typeof el.select === "function") el.select();
        if (typeof el.setSelectionRange === "function"){
          const v = el.value ?? "";
          el.setSelectionRange(0, String(v).length);
        }
      }catch(e){}
    }, 0);
  }
  document.addEventListener("focusin",(e)=>{
    const el = e.target;
    if (!(el instanceof HTMLElement)) return;
    if (el.tagName === "INPUT" || el.tagName === "TEXTAREA"){
      if (el.classList.contains("resinNameInput")) return;
      selectAllSoon(el);
    }
  });

  function rebuildUIFromState(payloadMaybe){
    ensureLayers();
    renderOffsetInputs();
    renderWeightsArea();
    renderSplitsArea();
    renderResinCalculator();
    updateLayerMetaDisplays();

    if (payloadMaybe && typeof payloadMaybe === "object"){
      const o = payloadMaybe.blocksOpen;
      if (o && typeof o === "object"){
        Object.entries(o).forEach(([id, isOpen])=>{
          const el = document.getElementById(id);
          if (el && typeof isOpen === "boolean") el.open = isOpen;
        });
      }
    }

    validateAndCompute();
  }

  function hookDetailsPersistence(){
    DETAILS_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener("toggle", saveSession);
    });
  }
function fmtRelFromNow(dateObj){
  if (!dateObj) return "—";
  const ms = dateObj.getTime() - Date.now();
  const mins = Math.round(ms / 60000);

  if (mins <= 0) return "now";
  if (mins < 60) return `in ${mins}m`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `in ${h}h ${String(m).padStart(2,"0")}m`;
}

function updateFooterNext(flat, changeoverDate){
  const msgEl = document.getElementById("footerMsg");
  const subEl = document.getElementById("footerSub");
  if (!msgEl || !subEl) return;

  if (!flat || flat.length === 0){
    msgEl.textContent = "No tracked hoppers";
    subEl.textContent = `ResinIQ • v${APP_VERSION}`;
    return;
  }

  // Prefer “pump off by” (startByDate) when changeover is set; otherwise soonest empty.
  let next = null;

  if (changeoverDate){
    const candidates = flat
      .filter(x => x.startByDate && Number.isFinite(x.totalMinutes) && !x.pumpOff);
    candidates.sort((a,b)=>a.startByDate.getTime()-b.startByDate.getTime());
    next = candidates[0] || null;

    if (next){
      msgEl.textContent = `Next pump off: ${next.hopperLabel}${next.resinName ? ` • ${next.resinName}` : ""}`;
      subEl.textContent = `${next.startByText} (${fmtRelFromNow(next.startByDate)}) • Changeover ${fmtTime(changeoverDate)}`;
      return;
    }
  }

  // Fallback: soonest empty (if no changeover or no valid start-by)
  const candidates2 = flat
    .filter(x => Number.isFinite(x.minutesToEmpty) && x.minutesToEmpty >= 0 && !x.pumpOff)
    .sort((a,b)=>a.minutesToEmpty-b.minutesToEmpty);

  next = candidates2[0] || null;

  if (next){
    msgEl.textContent = `Soonest empty: ${next.hopperLabel}${next.resinName ? ` • ${next.resinName}` : ""}`;
    subEl.textContent = `${next.timeText} • Total ${next.totalRundownText}`;
  } else {
    msgEl.textContent = "No upcoming hoppers (all checked off or missing data)";
    subEl.textContent = `ResinIQ • v${APP_VERSION}`;
  }
}

  // Wire inputs
  $("lineRate")?.addEventListener("input",(e)=>{ state.lineRate = clampNum(e.target.value); validateAndCompute(); saveSession(); });
  $("gauge").addEventListener("input",(e)=>{ state.gauge = clampNum(e.target.value); updateLayerMetaDisplays(); validateAndCompute(); saveSession(); });
  $("lineType")?.addEventListener("change",(e)=>{
    state.lineType = [1,3,5].includes(Number(e.target.value)) ? Number(e.target.value) : 3;
    ensureLayers();
    rebuildUIFromState();
    saveSession();
  });
  $("changeoverTime")?.addEventListener("input",(e)=>{ state.changeoverTime = e.target.value || ""; validateAndCompute(); saveSession(); });

  $("densitySel")?.addEventListener("change",(e)=>{
    applyDensity(e.target.value);
    saveSession();
  });

  $("themeSel")?.addEventListener("change",(e)=>{
    applyTheme(e.target.value);
    saveSession();
  });

  $("prodResinLb")?.addEventListener("input",(e)=>{ state.prodResinLb = clampNum(e.target.value); renderResinCalculator(); saveSession(); });
  $("scrapResinLb")?.addEventListener("input",(e)=>{ state.scrapResinLb = clampNum(e.target.value); renderResinCalculator(); saveSession(); });

  // Recipe buttons
  $("saveConfigBtn")?.addEventListener("click", saveNamedConfig);
  $("loadConfigBtn")?.addEventListener("click", loadSelectedConfig);
  $("renameConfigBtn")?.addEventListener("click", renameSelectedConfig);
  $("deleteConfigBtn")?.addEventListener("click", deleteSelectedConfig);
  $("exportConfigBtn")?.addEventListener("click", exportSelectedConfig);
  $("importConfigBtn")?.addEventListener("click", ()=>showImportUI(true));
  $("cancelImportBtn")?.addEventListener("click", ()=>{ showImportUI(false); const ij=$("importJson"); if (ij) ij.value=""; });
  $("doImportBtn")?.addEventListener("click", doImport);

  // Init
  (function init(){

    ensureLayers();

    const restored = loadSession();
    if (!restored){
      applyDensity("comfort");
      applyTheme("dark");
      rebuildUIFromState();
    }

    hookDetailsPersistence();
    refreshConfigDropdown();

    const selVal = $("savedConfigs")?.value;
    if (selVal && selVal !== "— none saved —"){
      const cn = $("configName");
      if (cn) cn.value = selVal;
    }

    // Ensure theme/logo applied even after restore
    applyTheme(state.theme || "dark");
    saveSession();
  })();
</script>
</body>
</html>
